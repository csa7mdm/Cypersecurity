"""
CVSS v3.1 Score Calculator

Implements the Common Vulnerability Scoring System v3.1
https://www.first.org/cvss/v3.1/specification-document
"""

from dataclasses import dataclass
from typing import Dict
from enum import Enum


class AttackVector(Enum):
    """Attack Vector (AV)"""
    NETWORK = ("N", 0.85)
    ADJACENT = ("A", 0.62)
    LOCAL = ("L", 0.55)
    PHYSICAL = ("P", 0.2)


class AttackComplexity(Enum):
    """Attack Complexity (AC)"""
    LOW = ("L", 0.77)
    HIGH = ("H", 0.44)


class PrivilegesRequired(Enum):
    """Privileges Required (PR)"""
    NONE = ("N", 0.85, 0.85)  # (abbr, unchanged, changed)
    LOW = ("L", 0.62, 0.68)
    HIGH = ("H", 0.27, 0.50)


class UserInteraction(Enum):
    """User Interaction (UI)"""
    NONE = ("N", 0.85)
    REQUIRED = ("R", 0.62)


class Scope(Enum):
    """Scope (S)"""
    UNCHANGED = ("U", False)
    CHANGED = ("C", True)


class Impact(Enum):
    """Impact metrics (C/I/A)"""
    NONE = ("N", 0.0)
    LOW = ("L", 0.22)
    HIGH = ("H", 0.56)


@dataclass
class CVSSVector:
    """CVSS v3.1 Vector"""
    attack_vector: AttackVector
    attack_complexity: AttackComplexity
    privileges_required: PrivilegesRequired
    user_interaction: UserInteraction
    scope: Scope
    confidentiality: Impact
    integrity: Impact
    availability: Impact
    
    def to_string(self) -> str:
        """Convert to CVSS vector string"""
        return (
            f"CVSS:3.1/"
            f"AV:{self.attack_vector.value[0]}/"
            f"AC:{self.attack_complexity.value[0]}/"
            f"PR:{self.privileges_required.value[0]}/"
            f"UI:{self.user_interaction.value[0]}/"
            f"S:{self.scope.value[0]}/"
            f"C:{self.confidentiality.value[0]}/"
            f"I:{self.integrity.value[0]}/"
            f"A:{self.availability.value[0]}"
        )


class CVSSCalculator:
    """
    CVSS v3.1 Score Calculator
    
    Calculates Base, Temporal, and Environmental scores
    according to CVSS v3.1 specification.
    """
    
    @staticmethod
    def calculate_base_score(vector: CVSSVector) -> float:
        """
        Calculate CVSS v3.1 Base Score
        
        Args:
            vector: CVSS vector with all metrics
        
        Returns:
            Base score (0.0 - 10.0)
        """
        # Get metric values
        av = vector.attack_vector.value[1]
        ac = vector.attack_complexity.value[1]
        
        # PR depends on scope
        if vector.scope == Scope.UNCHANGED:
            pr = vector.privileges_required.value[1]
        else:
            pr = vector.privileges_required.value[2]
        
        ui = vector.user_interaction.value[1]
        c = vector.confidentiality.value[1]
        i = vector.integrity.value[1]
        a = vector.availability.value[1]
        
        # Calculate Impact Sub Score (ISS)
        iss = 1 - ((1 - c) * (1 - i) * (1 - a))
        
        # Calculate Impact
        if vector.scope == Scope.UNCHANGED:
            impact = 6.42 * iss
        else:
            impact = 7.52 * (iss - 0.029) - 3.25 * pow(iss - 0.02, 15)
        
        # Calculate Exploitability
        exploitability = 8.22 * av * ac * pr * ui
        
        # Calculate Base Score
        if impact <= 0:
            return 0.0
        
        if vector.scope == Scope.UNCHANGED:
            base_score = min(impact + exploitability, 10.0)
        else:
            base_score = min(1.08 * (impact + exploitability), 10.0)
        
        # Round up to 1 decimal
        return round(base_score * 10) / 10
    
    @staticmethod
    def get_severity(score: float) -> str:
        """Get severity rating from score"""
        if score == 0.0:
            return "NONE"
        elif score < 4.0:
            return "LOW"
        elif score < 7.0:
            return "MEDIUM"
        elif score < 9.0:
            return "HIGH"
        else:
            return "CRITICAL"
    
    @staticmethod
    def parse_vector_string(vector_string: str) -> CVSSVector:
        """
        Parse CVSS vector string
        
        Args:
            vector_string: e.g., "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
        
        Returns:
            CVSSVector object
        """
        # Remove CVSS:3.1/ prefix
        if vector_string.startswith("CVSS:3.1/"):
            vector_string = vector_string[9:]
        
        metrics = {}
        for part in vector_string.split("/"):
            key, value = part.split(":")
            metrics[key] = value
        
        # Parse each metric
        av_map = {v.value[0]: v for v in AttackVector}
        ac_map = {v.value[0]: v for v in AttackComplexity}
        pr_map = {v.value[0]: v for v in PrivilegesRequired}
        ui_map = {v.value[0]: v for v in UserInteraction}
        s_map = {v.value[0]: v for v in Scope}
        i_map = {v.value[0]: v for v in Impact}
        
        return CVSSVector(
            attack_vector=av_map[metrics["AV"]],
            attack_complexity=ac_map[metrics["AC"]],
            privileges_required=pr_map[metrics["PR"]],
            user_interaction=ui_map[metrics["UI"]],
            scope=s_map[metrics["S"]],
            confidentiality=i_map[metrics["C"]],
            integrity=i_map[metrics["I"]],
            availability=i_map[metrics["A"]]
        )
    
    @classmethod
    def calculate_from_string(cls, vector_string: str) -> Dict:
        """
        Calculate score from vector string
        
        Returns:
            Dict with score, severity, and vector
        """
        vector = cls.parse_vector_string(vector_string)
        score = cls.calculate_base_score(vector)
        severity = cls.get_severity(score)
        
        return {
            "score": score,
            "severity": severity,
            "vector_string": vector.to_string()
        }


# Common vulnerability patterns
CVSS_TEMPLATES = {
    "sql_injection": CVSSVector(
        attack_vector=AttackVector.NETWORK,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.CHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.HIGH,
        availability=Impact.HIGH
    ),  # 9.8 CRITICAL
    
    "xss_reflected": CVSSVector(
        attack_vector=AttackVector.NETWORK,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.REQUIRED,
        scope=Scope.CHANGED,
        confidentiality=Impact.LOW,
        integrity=Impact.LOW,
        availability=Impact.NONE
    ),  # 6.1 MEDIUM
    
    "auth_bypass": CVSSVector(
        attack_vector=AttackVector.NETWORK,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.HIGH,
        availability=Impact.HIGH
    ),  # 9.8 CRITICAL
}
